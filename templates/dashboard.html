<div class="card">
    <h2>Smart Billing</h2>

    <form method="POST" action="/purchase" id="billForm">
        <div id="items"></div>

        <button type="button" onclick="addItem()">Add Item</button>

        <h3>Grand Total: ₹ <span id="grandTotal">0</span></h3>

        <button type="submit">Complete Purchase</button>
    </form>
</div>
<div class="card">
<h2>Analytics</h2>
<p>Total Sales: ₹ {{ total_sales }}</p>
<p>Total Users: {{ total_users }}</p>
</div>
<script>
let products = {{ products|tojson }};

function addItem() {
    const div = document.createElement("div");
    div.className = "row";

    let options = `<option value="">Select Product</option>`;
    products.forEach(p => {
        options += `<option value="${p[0]}" data-price="${p[2]}">${p[1]} (Stock: ${p[3]})</option>`;
    });

    div.innerHTML = `
        <select name="product_id[]" onchange="calculateTotal()" required>
            ${options}
        </select>
        <input type="number" name="quantity[]" min="1" value="1" onchange="calculateTotal()" required>
        <button type="button" onclick="this.parentElement.remove(); calculateTotal()">X</button>
    `;

    document.getElementById("items").appendChild(div);
}

function calculateTotal() {
    let total = 0;

    document.querySelectorAll("#items .row").forEach(row => {
        const select = row.querySelector("select");
        const qty = row.querySelector("input");

        if (select.selectedOptions[0]) {
            const price = parseFloat(select.selectedOptions[0].dataset.price || 0);
            total += price * parseInt(qty.value || 0);
        }
    });

    document.getElementById("grandTotal").innerText = total.toFixed(2);
}
</script>