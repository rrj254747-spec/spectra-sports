{% extends "layout.html" %}
{% block content %}

<div class="container">

    <div class="card">
        <h2>ðŸ§¾ Smart Billing</h2>

        <form method="POST" action="/purchase" id="billForm" onsubmit="return validateBeforeSubmit()">

            <div id="items"></div>

            <button type="button" class="btn secondary" onclick="addItem()">
                + Add Item
            </button>

            <h3 class="total">
                Grand Total: â‚¹ <span id="grandTotal">0.00</span>
            </h3>

            <button type="submit" class="btn primary">
                Complete Purchase
            </button>

        </form>
    </div>

</div>

<!-- ======================= -->
<!-- BILLING SCRIPT -->
<!-- ======================= -->
<script>

let products = {{ products | tojson | safe }};

function addItem() {

    const container = document.getElementById("items");
    const div = document.createElement("div");
    div.className = "row";

    let options = `<option value="">Select Product</option>`;

    products.forEach(p => {
        options += `
            <option value="${p[0]}"
                    data-price="${p[2]}"
                    data-stock="${p[3]}">
                ${p[1]} (â‚¹${p[2]} | Stock: ${p[3]})
            </option>
        `;
    });

    div.innerHTML = `
        <select name="product_id[]" onchange="calculateTotal()" required>
            ${options}
        </select>

        <input type="number"
               name="quantity[]"
               min="1"
               value="1"
               onchange="calculateTotal()"
               required>

        <button type="button" class="remove-btn" onclick="removeRow(this)">
            âœ–
        </button>
    `;

    container.appendChild(div);
}

function removeRow(button) {
    button.parentElement.remove();
    calculateTotal();
}

function calculateTotal() {

    let total = 0;
    let selectedProducts = new Set();

    document.querySelectorAll("#items .row").forEach(row => {

        const select = row.querySelector("select");
        const qtyInput = row.querySelector("input");

        if (!select.value) return;

        const selectedOption = select.selectedOptions[0];

        const price = parseFloat(selectedOption.dataset.price || 0);
        const stock = parseInt(selectedOption.dataset.stock || 0);
        const qty = parseInt(qtyInput.value || 0);

        if (qty > stock) {
            alert("Not enough stock for " + selectedOption.text);
            qtyInput.value = 1;
            return;
        }

        total += price * qty;
    });

    document.getElementById("grandTotal").innerText = total.toFixed(2);
}

function validateBeforeSubmit() {

    const rows = document.querySelectorAll("#items .row");

    if (rows.length === 0) {
        alert("Please add at least one product.");
        return false;
    }

    let selectedProducts = new Set();

    for (let row of rows) {

        const select = row.querySelector("select");
        const qtyInput = row.querySelector("input");

        if (!select.value) {
            alert("Please select a product.");
            return false;
        }

        if (selectedProducts.has(select.value)) {
            alert("Duplicate product not allowed in same bill.");
            return false;
        }

        selectedProducts.add(select.value);

        const stock = parseInt(select.selectedOptions[0].dataset.stock);
        const qty = parseInt(qtyInput.value);

        if (qty > stock) {
            alert("Stock exceeded for " + select.selectedOptions[0].text);
            return false;
        }
    }

    return true;
}

// Auto add first row on load
window.onload = function() {
    if (products.length > 0) {
        addItem();
    }
};

</script>

<!-- ======================= -->
<!-- STYLING -->
<!-- ======================= -->
<style>

.container {
    max-width: 1000px;
    margin: auto;
    padding: 30px;
}

.card {
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.25);
}

.row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

select, input {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: none;
}

.btn {
    padding: 10px 15px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-top: 10px;
}

.primary {
    background: #4cafef;
    color: white;
}

.secondary {
    background: #555;
    color: white;
}

.remove-btn {
    background: #ff4d4d;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}

.total {
    margin-top: 15px;
    font-weight: bold;
}

</style>

{% endblock %}